<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"mybatis-3-mapper.dtd">
<mapper namespace="com.wind.busi.yyhr">

	<select id="selectBusi_hr" resultType="hashMap" parameterType="hashMap">
		<if test="record_count == null and page != null and page != ''">
			select * from (select rownum as rowidx, qry.* from (
		</if>
		select
		<if test="record_count == null">
			*
		</if>
		<if test="record_count != null">
			count(1) as record_count
		</if>
		from v_busi_hr
		<where>
			<if test="HR_NAME_LIKE != null and HR_NAME_LIKE != ''">
				hr_name like #{HR_NAME_LIKE} || '%'
			</if>
			<if test="IDCARD_LIKE != null and IDCARD_LIKE != ''">
				and idcard like #{IDCARD_LIKE} || '%'
			</if>
			<if test="IDCARD != null and IDCARD != ''">
				and idcard = #{IDCARD}
			</if>
			<if test="LD_TYPE != null and LD_TYPE != ''">
				and ld_type = #{LD_TYPE}
			</if>
			<if test="IS_DELED == null || IS_DELED == '' || IS_DELED == 0">
				and is_deled = '0'
			</if>
			<if test="HR_ID != null and HR_ID != ''">
				and hr_id = #{HR_ID}
			</if>
			<if test="IS_JOB != null and IS_JOB != ''">
				and IS_JOB = #{IS_JOB}
			</if>
			<if test="jntcSet != null">
				and hr_id in 
				<foreach collection="jntcSet" index="index" item="item" open="(" separator="union all" close=")">
              		select hr_id from v_hr_jntc where UTL_MATCH.edit_distance_similarity(v_hr_jntc.jntc, #{item}) >= 60      
        		</foreach>  
			</if>
			<if test="wantJobNameSet != null">
				and hr_id in 
				<foreach collection="wantJobNameSet" index="index" item="item" open="(" separator="union all" close=")">
              		select hr_id from V_HR_WANT_JOB_NAME where UTL_MATCH.edit_distance_similarity(V_HR_WANT_JOB_NAME.WANT_JOB_NAME, #{item}) >= 60      
        		</foreach>  
			</if>
			<if test="IS_WANT_JOB != null and IS_WANT_JOB != ''">
				and IS_WANT_JOB = #{IS_WANT_JOB}
			</if>
			<if test="HJ_AREA != null and HJ_AREA != ''">
				<choose>
					<when test="HJ_AREA_BJ != null and HJ_AREA_BJ  != ''">
						and hj_area = #{HJ_AREA}
					</when>
					<otherwise>
						<choose>
							<when test="HJ_AREA_LEVEL == 0">
								and province_code_hj = #{HJ_AREA}
							</when>
							<when test="HJ_AREA_LEVEL == 1">
								and city_code_hj = #{HJ_AREA}
							</when>
							<when test="HJ_AREA_LEVEL == 2">
								and country_code_hj = #{HJ_AREA}
							</when>
							<when test="HJ_AREA_LEVEL == 3">
								and street_code_hj = #{HJ_AREA}
							</when>
							<when test="HJ_AREA_LEVEL == 4">
								and village_code_hj = #{HJ_AREA}
							</when>
						</choose>
					</otherwise>
				</choose>
			</if>
		</where>
		order by hj_area, idcard
		<if test="record_count == null and page != null and page != ''">
			)qry ) where rowidx > (#{page} - 1) * #{rows} and rowidx
			&lt;= #{page} * #{rows}
		</if>
	</select>
	
	<select id="selectBs_h_need_service" resultType="hashMap"
		parameterType="hashMap">
		select * from BS_H_NEED_SERVICE
		<where>
			<if test="HR_ID != null and HR_ID != ''">
				hr_id = #{HR_ID}
			</if>
		</where>
	</select>
	
	<sql id="jobNojobDetail">
		from v_jobnojob_list_name a inner join V_BUSI_HR b on a.hr_id = b.hr_id left outer join v_company_account  c on a.OPR_ID = c.c_id
		<where>
			<if test="HR_ID != null and HR_ID != ''">
				a.hr_id = #{HR_ID}
			</if>
			<if test="opr_id != null and opr_id != ''">
				and a.opr_id = #{opr_id}
			</if>
			<if test="opr_type != null and opr_type != ''">
				and a.opr_type = #{opr_type}
			</if>
			<if test="in_time_bgn != null and in_time_bgn != ''">
				and a.in_time >= to_date(#{in_time_bgn}, 'yyyy-mm-dd')
			</if>
			<if test="in_time_end != null and in_time_end != ''">
				and a.in_time &lt; to_date(#{in_time_end}, 'yyyy-mm-dd')
			</if>
			<if test="HJ_AREA != null and HJ_AREA != ''">
				<choose>
					<when test="HJ_AREA_BJ != null and HJ_AREA_BJ  != ''">
						and b.hj_area = #{HJ_AREA}
					</when>
					<otherwise>
						<choose>
							<when test="HJ_AREA_LEVEL == 0">
								and b.province_code_hj = #{HJ_AREA}
							</when>
							<when test="HJ_AREA_LEVEL == 1">
								and b.city_code_hj = #{HJ_AREA}
							</when>
							<when test="HJ_AREA_LEVEL == 2">
								and b.country_code_hj = #{HJ_AREA}
							</when>
							<when test="HJ_AREA_LEVEL == 3">
								and b.street_code_hj = #{HJ_AREA}
							</when>
							<when test="HJ_AREA_LEVEL == 4">
								and b.village_code_hj = #{HJ_AREA}
							</when>
						</choose>
					</otherwise>
				</choose>
			</if>
		</where>
	</sql>

	<select id="selectBs_job_nojob" resultType="hashMap"
		parameterType="hashMap">
		<if test="record_count == null and page != null and page != ''">
			select * from (select rownum as rowidx, qry.* from (
		</if>
		select
		<if test="record_count == null">
			a.*, b.hr_name, b.hj_area_name, c.c_name
		</if>
		<if test="record_count != null">
			count(1) as record_count
		</if>
		<include refid="jobNojobDetail"/>
		order by job_time desc
		<if test="record_count == null and page != null and page != ''">
			)qry ) where rowidx > (#{page} - 1) * #{rows} and rowidx
			&lt;= #{page} * #{rows}
		</if>
	</select>
	
	<select id="selectBs_job_nojob_tj" resultType="hashMap"
		parameterType="hashMap">
		<if test="record_count == null and page != null and page != ''">
			select * from (select rownum as rowidx, qry.* from (
		</if>
		select
		<if test="record_count == null">
			aa.province_name,
	       	aa.city_name,
	       	aa.COUNTRY_name,
	       	aa.street_name,
	       	aa.village_name,
	       	aa.AREA_CODE,
	       	aa.AREA_NAME,
	       	bb.job_count,
	       	bb.c_id,
	       	bb.c_name
		</if>
		<if test="record_count != null">
			count(1) as record_count
		</if>
		  from v_com_area aa
 		  inner join (select hj_area, c_id, c_name, count(1) as job_count
               from (
		select *  <include refid="jobNojobDetail"/>
		order by job_time desc
		) group by hj_area, c_id, c_name) bb
		    on aa.AREA_CODE = bb.hj_area
		<if test="record_count == null and page != null and page != ''">
			)qry ) where rowidx > (#{page} - 1) * #{rows} and rowidx
			&lt;= #{page} * #{rows}
		</if>
	</select>

	<select id="selectV_jobnojob_last_list" resultType="hashMap"
		parameterType="hashMap">
		select * from v_jobnojob_last_list
		<where>
			<if test="HR_ID != null and HR_ID != ''">
				hr_id = #{HR_ID}
			</if>
		</where>
		order by job_time desc
	</select>

	<select id="selectBs_company" resultType="hashMap"
		parameterType="hashMap">
		<if test="record_count == null and page != null and page != ''">
			select * from (select rownum as rowidx, qry.* from (
		</if>
		select
		<if test="record_count == null">
			*
		</if>
		<if test="record_count != null">
			count(1) as record_count
		</if>
		from bs_company
		<where>
			<if test="C_NAME_LIKE != null and C_NAME_LIKE != ''">
				C_NAME like #{C_NAME_LIKE} || '%'
			</if>
			<if test="C_NAME != null and C_NAME != ''">
				and C_NAME = #{C_NAME}
			</if>
			<if test="C_ID != null and C_ID != ''">
				and C_ID = #{C_ID}
			</if>
			<if test="C_TYPE != null and C_TYPE != ''">
				and C_TYPE = #{C_TYPE}
			</if>
			<if test="C_ID_WT != null and C_ID_WT != ''">
				and C_ID_WT = #{C_ID_WT}
			</if>
			<if test="C_ID_MGE != null and C_ID_MGE != ''">
				and (C_ID = #{C_ID_MGE} or C_ID_WT = #{C_ID_MGE})
			</if>
		</where>
		order by in_time desc
		<if test="record_count == null and page != null and page != ''">
			)qry ) where rowidx > (#{page} - 1) * #{rows} and rowidx
			&lt;= #{page} * #{rows}
		</if>
	</select>

	<select id="selectBs_position" resultType="hashMap"
		parameterType="hashMap">
		<if test="record_count == null and page != null and page != ''">
			select * from (select rownum as rowidx, qry.* from (
		</if>
		select
		<if test="record_count == null">
			v_bs_position.*, bs_company.c_name
		</if>
		<if test="record_count != null">
			count(1) as record_count
		</if>
		from v_bs_position inner join bs_company on v_bs_position.c_id =
		bs_company.c_id
		<where>
			<if test="P_NAME_LIKE != null and P_NAME_LIKE != ''">
				P_NAME like #{P_NAME_LIKE} || '%'
			</if>
			<if test="P_ID != null and P_ID != ''">
				and P_ID = #{P_ID}
			</if>
			<if test="C_ID != null and C_ID != ''">
				and (v_bs_position.C_ID = #{C_ID} or bs_company.C_ID_WT =
				#{C_ID})
			</if>
			<if test="P_STATUS != null and P_STATUS != ''">
				and P_STATUS = #{P_STATUS}
			</if>
			<if test="P_NAME != null and P_NAME != ''">
				and P_NAME = #{P_NAME}
			</if>
			<if test="pNameSet != null">
			    and
				<foreach collection="pNameSet" item="item" open="(" separator="or" close=")">
              		UTL_MATCH.edit_distance_similarity(P_NAME, #{item}) >= 60      
        		</foreach>  
			</if>
			<if test="VALID != null and VALID != ''">
				and P_STATUS = '1' and end_time >= to_char(sysdate,
				'yyyy-mm-dd')
			</if>
			<if test="pay_botton_bgn != null and pay_botton_bgn != ''">
				and pay_botton >= #{pay_botton_bgn}
			</if>
			<if test="P_WORK_AREA != null and P_WORK_AREA != ''">
				<choose>
					<when test="P_WORK_AREA_LEVEL == 0">
						and p_work_area_province_code = #{P_WORK_AREA}
					</when>
					<when test="P_WORK_AREA_LEVEL == 1">
						and p_work_area_city_code = #{P_WORK_AREA}
					</when>
					<when test="P_WORK_AREA_LEVEL == 2">
						and p_work_area_country_code = #{P_WORK_AREA}
					</when>
					<when test="P_WORK_AREA_LEVEL == 3">
						and p_work_area_street_code = #{P_WORK_AREA}
					</when>
					<when test="P_WORK_AREA_LEVEL == 4">
						and p_work_area_village_code = #{P_WORK_AREA}
					</when>
				</choose>
			</if>
		</where>
		order by v_bs_position.in_time desc
		<if test="record_count == null and page != null and page != ''">
			)qry ) where rowidx > (#{page} - 1) * #{rows} and rowidx
			&lt;= #{page} * #{rows}
		</if>
	</select>

	<select id="selectBs_position_req" resultType="hashMap"
		parameterType="hashMap">
		<if test="record_count == null and page != null and page != ''">
			select * from (select rownum as rowidx, qry.* from (
		</if>
		select
		<if test="record_count == null">
			v_bs_position_req.*, V_BS_POSITION.p_name, V_BS_POSITION.p_work_area_name, V_BS_POSITION.p_work_area,V_BS_POSITION.p_pay_botton,
			bs_company.c_name, V_BUSI_HR.hr_name, V_BUSI_HR.age, V_BUSI_HR.sex_name, V_BUSI_HR.degree_name, V_BUSI_HR.jntc, V_BUSI_HR.hj_area_name,
			V_BUSI_HR.IDCARD_COVERD,V_BUSI_HR.IDCARD
		</if>
		<if test="record_count != null">
			count(1) as record_count
		</if>
		from v_bs_position_req
		inner join V_BS_POSITION
		on v_bs_position_req.P_ID = V_BS_POSITION.P_ID
		inner join bs_company
		on V_BS_POSITION.c_id = bs_company.c_id
		inner join V_BUSI_HR
		on V_BUSI_HR.hr_id = v_bs_position_req.HR_ID
		<where>
			<if test="P_ID != null and P_ID != ''">
				v_bs_position_req.P_ID = #{P_ID}
			</if>
			<if test="REQ_ID != null and REQ_ID != ''">
				v_bs_position_req.REQ_ID = #{REQ_ID}
			</if>
			<if test="HR_ID != null and HR_ID != ''">
				and v_bs_position_req.HR_ID = #{HR_ID}
			</if>
			<if test="C_ID != null and C_ID != ''">
				and bs_company.C_ID = #{C_ID}
			</if>
			<if test="owner_id != null and owner_id != ''">
				and (bs_company.C_ID = #{owner_id} or bs_company.c_type = '4' and c_id_wt = #{owner_id})
			</if>
			<if test="req_status != null and req_status != ''">
				and v_bs_position_req.req_status = #{req_status}
			</if>
			<if test="P_NAME_LIKE != null and P_NAME_LIKE != ''">
				and bs_position.p_name like '%' || #{P_NAME_LIKE} || '%'
			</if>
		</where>
		order by v_bs_position_req.in_time desc
		<if test="record_count == null and page != null and page != ''">
			)qry ) where rowidx > (#{page} - 1) * #{rows} and rowidx
			&lt;= #{page} * #{rows}
		</if>
	</select>
	
	<insert id="insertBs_hr_imp_pre"  parameterType="hashMap">  
   		insert into BS_HR_IMP_PRE (  
   					batch_id,
   					row_no,
					hr_name ,
					idcard,
					hj_area_name ,
					nation_name,
					degree_name,
					school,
					gra_year,
					pro ,
					address ,
					phone ,
					qq,
					email ,
					jntc,
					is_job,
					is_want_job,
					job_time,
					job_area_name,
					job_type_name,
					job_dw,
					job_gw,
					income,
					want_job_area_name ,
					want_income,
					want_job_name)   
		values (#{batchId},
   		<foreach collection="row" item="item" separator=" , " >  
       		 #{item} 
    	</foreach>  
    	)
	</insert> 
	
	<select id="f_hr_imp_deal" statementType="CALLABLE" parameterType="hashMap">  
 		{#{result,mode=OUT,jdbcType=VARCHAR} = call f_hr_imp_deal(#{batch_id,mode=IN,jdbcType=VARCHAR},
 																	#{opr_id,mode=IN,jdbcType=VARCHAR},
 																	#{opr_type,mode=IN,jdbcType=VARCHAR},
 																	#{opr_area,mode=IN,jdbcType=VARCHAR})}  
 	</select>
 	
 	<select id="selectBs_hr_imp_pre" resultType="hashMap"
		parameterType="string">
		select row_no, error_info from BS_HR_IMP_PRE where batch_id = #{batch_id} and error_info is not null
	</select>

</mapper>